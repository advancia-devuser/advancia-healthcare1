name: Label Audit

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: "0 10 1 * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: read

jobs:
  verify-labels:
    name: Verify governance labels exist
    runs-on: ubuntu-latest
    steps:
      - name: Check required labels
        uses: actions/github-script@v7
        with:
          script: |
            const required = [
              'security',
              'ci',
              'dependencies',
              'docs',
              'release',
              'needs-triage',
              'risk:low',
              'risk:medium',
              'risk:high',
            ];

            const labels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const existing = new Set(labels.map((l) => l.name));
            const missing = required.filter((name) => !existing.has(name));

            const lines = [];
            lines.push('## Label audit summary');
            lines.push('');
            lines.push(`Required labels: ${required.length}`);
            lines.push(`Missing labels: ${missing.length}`);
            lines.push('');
            lines.push('| Label | Status |');
            lines.push('|---|---|');
            for (const name of required) {
              lines.push(`| ${name} | ${existing.has(name) ? '✅ present' : '❌ missing'} |`);
            }
            require('node:fs').appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${lines.join('\n')}\n`);

            if (missing.length > 0) {
              core.setFailed(`Missing required labels: ${missing.join(', ')}`);
            }
