name: Triage Reminder

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  remind-needs-triage:
    name: Remind stale needs-triage issues
    runs-on: ubuntu-latest
    steps:
      - name: Add reminder comments to stale issues
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- needs-triage-reminder -->';
            const cutoffMs = 24 * 60 * 60 * 1000;
            const cutoff = Date.now() - cutoffMs;

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'needs-triage',
              per_page: 100,
            });

            let reminded = 0;

            for (const issue of issues) {
              if (issue.pull_request) continue;
              const createdAt = new Date(issue.created_at).getTime();
              if (createdAt > cutoff) continue;

              const comments = await github.paginate(github.rest.issues.listComments, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100,
              });

              const alreadyCommented = comments.some((c) => c.body && c.body.includes(marker));
              if (alreadyCommented) continue;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `${marker}\nThis issue has been labeled \`needs-triage\` for over 24 hours.\n\nPlease assign an owner and set initial severity/domain classification per \`docs/label-glossary.md\`.`,
              });

              reminded += 1;
            }

            core.info(`Triage reminders posted: ${reminded}`);
